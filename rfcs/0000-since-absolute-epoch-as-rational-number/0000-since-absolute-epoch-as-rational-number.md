---
Number: "0000"
Category: Consensus (Soft Fork)
Status: Draft
Author: Ian Yang
Organization: Nervos Foundation
Created: 2021-02-04
---

# Use the rational number to verify that a transaction is mature since an absolute epoch number with a fraction

## Abstract

This document proposes to fix a bug in the CKB reference implementation. When a transaction input uses the absolute epoch in the `since` field, the `value` must be converted to a rational number before the comparison.

## Motivation

The `value` parted is an encoded number `epoch + index / length`. In CKB, every block is also assigned an epoch number with a fraction. If the block is the `I`th block in the epoch which epoch number is `E` and length is `L`, its epoch number with the fraction is `E + I / L` and `I` must be less than `L`. 

To verify that a transaction is mature since an absolute epoch number with a fraction, the current implementation assumes that `index` must be less than `length` and checks that:

```
E \> epoch
or (E == epoch and I / L \>= index/length)
```

This document suggests using the rational number operations to verify that

```
E + I / L \>= epoch + index / length
```

See RFC17 [Transaction valid since](../0017-tx-valid-since/0017-tx-valid-since.md) for details of the `since` field encoding patterns.

## Specification

When an input `since` field is present, and

* The `metric_flag` is epoch (01).
* The `relative_flag` is absolute (0).

Providing that `value` is the encoded number `epoch + index / length`, and the current epoch number with the fraction is `E + I / L`, the transaction is considered mature when

```
E + I / L \>= epoch + index / length
```

using rational number operations, or

```
E * L * length + I * length \>= epoch * L * length + index * L
```

using integer number operations.

## Test Vectors

When `since` uses the absolute epoch `99 + 360 / 180`, and the current epoch is `100 + 0 / 180`, the transaction is mature using the old consensus rule but is immature using the new rule.

## Deployment

The deployment can be performed in two stages.

The first stage will activate the new consensus rule starting from a specific epoch. The mainnet and testnet will use different starting epochs and all other chains will use the new rule from epoch 0.

The second stage is optional. After the new rule has been activated, and the blocks in the chain before activation can also pass the new consensus rule, the old rule can be removed and all chains will use the new rule starting from the genesis block.

## Backward compatibility

The new rule is striker than the old one thus it can be deployed via a soft fork. When most nodes have upgraded to the new version, the old versions can keep up to date although blocks generated by old versions may be rejected by new version nodes. 

